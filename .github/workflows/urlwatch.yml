name: urlwatch

on:
  schedule:
    - cron: '*/30 * * * *'    # 30分おき（UTC）
  workflow_dispatch:         # 手動実行ボタン

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade urlwatch keyrings.alt playwright
          playwright install chromium

          - name: Run urlwatch
        env:
          URLWATCH_EMAIL_USER: ${{ secrets.MAIL_USER }}
          URLWATCH_EMAIL_PASS: ${{ secrets.MAIL_PASS }}
        run: |
          # 1) 設定ディレクトリ作成
          mkdir -p ~/.config/urlwatch
          # 2) 監視リストをコピー
          cp urls.yaml ~/.config/urlwatch/urls.yaml

          # 3) reporters: 形式で設定ファイルを echo で生成
          echo 'reporters:'                                                  > ~/.config/urlwatch/urlwatch.yaml
          echo '  email:'                                                    >> ~/.config/urlwatch/urlwatch.yaml
          echo '    enabled: true'                                           >> ~/.config/urlwatch/urlwatch.yaml
          echo '    keyring: false'                                          >> ~/.config/urlwatch/urlwatch.yaml
          echo '    from:     "'"${URLWATCH_EMAIL_USER}"'"'                  >> ~/.config/urlwatch/urlwatch.yaml
          echo '    to:       "'"${URLWATCH_EMAIL_USER}"'"'                  >> ~/.config/urlwatch/urlwatch.yaml
          echo '    smtp:'                                                   >> ~/.config/urlwatch/urlwatch.yaml
          echo '      host:      smtp.gmail.com'                             >> ~/.config/urlwatch/urlwatch.yaml
          echo '      port:      587'                                        >> ~/.config/urlwatch/urlwatch.yaml
          echo '      starttls:  true'                                       >> ~/.config/urlwatch/urlwatch.yaml
          echo '      user:      "'"${URLWATCH_EMAIL_USER}"'"'               >> ~/.config/urlwatch/urlwatch.yaml
          echo '      password:  "'"${URLWATCH_EMAIL_PASS}"'"'               >> ~/.config/urlwatch/urlwatch.yaml

          # 4) テストメールを飛ばして SMTP 設定を検証
          urlwatch --test-reporter email
